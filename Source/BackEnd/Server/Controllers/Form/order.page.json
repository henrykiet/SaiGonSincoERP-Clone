{
	"controller": "order",
	"type": "voucher",
	"formId": "order",
	"primaryKey": [
		"idGui"
	],
	"idVC": "Z03",
	"VCDate": "",
	"title": "",
	"class": "onSelectChange()",
	"tabs": [
		{
			"title": "Đơn hàng",
			"class": "text-[48px] px-4 py-2 focus:outline-none",
			"form": {
				"title": "Thông tin đơn hàng",
				"class": "",
				"formId": "Order",
				"fields": [
					{
						"key": "idGui",
						"label": "Key",
						"type": "hidden"
					},
					{
						"key": "customerID",
						"label": "Mã khách hàng",
						"required": true,
						"type": "lookup",
						"multiple": false,
						"default": {
							"controller": "customer",
							"filter": [
								{
									"field": "status",
									"value": "1",
									"operator": "="
								}
							]
						},
						"onChange": {
							"api": "/api/CustomQuery/execute",
							"params": [
								"customerID"
							],
							"dataType": [
								"String"
							],
							"query": "select address as DeliveryAddress from customer where customer_id = @customerID",
							"map": {
								"DeliveryAddress": "DeliveryAddress"
							}
						}
					},
					{
						"key": "jobCode",
						"label": "Dự án",
						"required": false,
						"type": "lookup",
						"multiple": false,
						"default": {
							"controller": "job",
							"filter": [
								{
									"field": "status",
									"value": "1",
									"operator": "="
								}
							]
						}
					},
					{
						"key": "voucherDate",
						"label": "Ngày tạo",
						"required": true,
						"type": "date",
						"default": "now",
						"placeholder": "Chọn ngày tạo"
					},
					{
						"key": "voucherNumber",
						"label": "Số đơn đặt hàng",
						"type": "text",
						"required": true,
						"placeholder": "Số đơn đặt hàng"
					},
					{
						"key": "DeliveryDate",
						"label": "Ngày giao hàng",
						"type": "date",
						"required": false,
						"placeholder": ""
					},
					{
						"key": "DeliveryCust",
						"label": "Người liên hệ giao hàng",
						"type": "text",
						"required": false,
						"placeholder": ""
					},
					{
						"key": "DeliveryAddress",
						"label": "Địa chỉ đặt hàng",
						"type": "text",
						"required": false,
						"placeholder": ""
					},
					{
						"key": "DeliveryEmail",
						"label": "Email người liên hệ báo giá",
						"type": "text",
						"required": false,
						"placeholder": ""
					},
					{
						"key": "DeliveryPhone",
						"label": "Điện thoại người liên hệ giao hàng",
						"type": "text",
						"required": false,
						"placeholder": ""
					},
					{
						"key": "SaleID",
						"label": "Mã NVKD",
						"required": false,
						"type": "lookup",
						"multiple": false,
						"default": {
							"controller": "Employee",
							"filter": [
								{
									"field": "status",
									"value": "1",
									"operator": "="
								}
							]
						}
					},
					{
						"key": "OrderCreatorPhone",
						"label": "Số Điện thoại người tạo",
						"type": "text",
						"required": false,
						"placeholder": ""
					},
					{
						"key": "OrderCreatorFax",
						"label": "Số Fax",
						"type": "text",
						"required": false,
						"placeholder": ""
					},
					{
						"key": "OrderCreatorMail",
						"label": "Mail (Người gửi)",
						"type": "text",
						"required": false,
						"placeholder": ""
					},
					{
						"key": "note",
						"label": "Ghi chú",
						"type": "text",
						"required": false,
						"placeholder": ""
					},
					{
						"key": "status",
						"label": "Trạng thái",
						"type": "select",
						"required": true,
						"options": [
							{
								"label": "Lập chứng từ",
								"value": "0"
							},
							{
								"label": "Hủy",
								"value": "9"
							}
						]
					},
					{
						"key": "statusApprove",
						"label": "Trạng thái duyệt",
						"type": "select",
						"required": false,
						"disabled": true,
						"subtotal": false,
						"options": [
							{
								"label": "Chờ duyệt",
								"value": "1"
							},
							{
								"label": "Duyệt",
								"value": "2"
							}
						]
					},
					{
						"key": "total_quantity",
						"label": "Tổng số lượng",
						"type": "number",
						"disabled": true,
						"subtotal": true,
						"calculation": {
							"calculations": [
								{
									"formula": "[total_quantity] = SUM([quantity])",
									"dependencies": [
										"quantity"
									],
									"precision": 2
								}
							]
						}
					},
					{
						"key": "total_amount",
						"label": "Tổng tiền",
						"type": "number",
						"currency": "VN",
						"disabled": true,
						"subtotal": true,
						"calculation": {
							"calculations": [
								{
									"formula": "[total_amount] = SUM([amount])",
									"dependencies": [
										"amount"
									],
									"precision": 2
								}
							]
						}
					},
					{
						"key": "total_vat",
						"label": "Tổng thuế",
						"type": "number",
						"currency": "VN",
						"disabled": true,
						"subtotal": true,
						"calculation": {
							"calculations": [
								{
									"formula": "[total_vat] = SUM([vat])",
									"dependencies": [
										"vat"
									],
									"precision": 2
								}
							]
						}
					},
					{
						"key": "total_payment",
						"label": "Tổng tiền sau thuế",
						"type": "number",
						"disabled": true,
						"subtotal": true,
						"currency":  "VN",
						"calculation": {
							"calculations": [
								{
									"formula": "[total_payment] = SUM([payment])",
									"dependencies": [
										"payment"
									],
									"precision": 2
								}
							]
						}
					}
				],
				"initialData": {}
			},
			"detail": [
				{
					"title": "Chi tiết",
					"controllerDetail": "orderDetail",
					"formId": "orderDetail",
					"foreignKey": "idGui, line_nbr",
					"fields": [
						{
							"key": "line_nbr",
							"label": "Stt",
							"disabled": true,
							"type": "text",
							"width": "80px"
						},
						{
							"key": "itemNameCustomer",
							"label": "Tên Vật tư KH",
							"type": "text",
							"width": "250px"
						},
						{
							"key": "uomCust",
							"label": "Đơn vị tính KH",
							"required": true,
							"width": "150px",
							"type": "lookup",
							"multiple": false,
							"default": {
								"controller": "uom",
								"filter": [
									{
										"field": "status",
										"value": "1",
										"operator": "="
									}
								]
							}
						},
						{
							"key": "itemCode",
							"label": "Mã vật tư",
							"required": true,
							"type": "lookup",
							"width": "450px",
							"multiple": false,
							"default": {
								"controller": "item",
								"filter": [
									{
										"field": "status",
										"value": "1",
										"operator": "="
									}
								]
							},
							"onChange": {
								"api": "/api/CustomQuery/execute",
								"params": [
									"itemCode"
								],
								"dataType": [
									"String"
								],
								"query": "select uom from item where item_id = @itemCode",
								"map": {
									"uom": "uom"
								}
							}
						},
						{
							"key": "uom",
							"label": "Đơn vị tính",
							"required": true,
							"type": "lookup",
							"width": "150px",
							"multiple": false,
							"default": {
								"controller": "uom",
								"filter": [
									{
										"field": "status",
										"value": "1",
										"operator": "="
									}
								]
							}
						},
						{
							"key": "quantity",
							"label": "Số lượng",
							"width": "150px",
							"type": "number",
							"trigger": [
								"amount",
								"amountCur",
								"vat",
								"vatCur",
								"payment",
								"paymentCur"
							]
						},
						{
							"key": "priceCur",
							"label": "Đơn giá ",
							"type": "hidden",
							"width": "150px",
							"currency": "VN",
							"trigger": [
								"amountCur",
								"vatCur",
								"paymentCur"
							]
						},
						{
							"key": "price",
							"label": "Đơn giá",
							"type": "number",
							"width": "150px",
							"currency": "VN",
							"trigger": [
								"amount",
								"vat",
								"payment"
							]
						},
						{
							"key": "purchasePrice",
							"label": "Giá mua",
							"currency": "VN",
							"width": "150px",
							"type": "hidden"
						},
						{
							"key": "amount",
							"label": "Thành tiền",
							"currency": "VN",
							"width": "150px",
							"type": "number",
							"trigger": [
								"vat",
								"payment"
							],
							"calculation": {
								"calculations": [
									{
										"formula": "[amount] = [quantity] * [price]",
										"dependencies": [
											"quantity",
											"price"
										],
										"precision": 0
									}
								]
							}
						},
						{
							"key": "amountCur",
							"label": "Thành tiền",
							"width": "150px",
							"type": "hidden",
							"trigger": [
								"vatCur",
								"paymentCur"
							],
							"calculation": {
								"calculations": [
									{
										"formula": "[amountCur] = [quantity] * [priceCur]",
										"dependencies": [
											"quantity",
											"priceCur"
										],
										"precision": 0
									}
								]
							}
						},
						{
							"key": "taxCode",
							"label": "Mã thuế",
							"type": "lookup",
							"width": "150px",
							"multiple": false,
							"default": {
								"controller": "tax",
								"filter": [
									{
										"field": "1",
										"value": "1",
										"operator": "="
									}
								]
							},
							"onChange": {
								"api": "/api/CustomQuery/execute",
								"params": [
									"taxCode"
								],
								"dataType": [
									"String"
								],
								"query": "select tax_number as tax_rate from tax where tax_id = @taxCode",
								"map": {
									"tax_rate": "tax_rate"
								}
							}
						},
						{
							"key": "tax_rate",
							"label": "Thuế suất",
							"width": "150px",
							"type": "number",
							"trigger": [
								"vat",
								"vatCur",
								"payment",
								"paymentCur"
							]
						},
						{
							"key": "vatCur",
							"label": "Thuế VAT",
							"width": "150px",
							"type": "hidden",
							"trigger": [
								"paymentCur"
							],
							"calculation": {
								"calculations": [
									{
										"formula": "[vatCur] = [amountCur] * [tax_rate] / 100",
										"dependencies": [
											"amountCur",
											"tax_rate"
										],
										"precision": 0
									}
								]
							}
						},
						{
							"key": "vat",
							"label": "Thuế VAT",
							"width": "150px",
							"currency": "VN",
							"type": "number",
							"trigger": [
								"payment"
							],
							"calculation": {
								"calculations": [
									{
										"formula": "[vat] = [amount] * [tax_rate] / 100",
										"dependencies": [
											"amount",
											"tax_rate"
										],
										"precision": 0
									}
								]
							}
						},
						{
							"key": "paymentCur",
							"label": "paymentCur",
							"width": "150px",
							"type": "hidden",
							"trigger": [],
							"calculation": {
								"calculations": [
									{
										"formula": "[paymentCur] = [amountCur] * [vatCur]",
										"dependencies": [
											"amountCur",
											"vatCur"
										],
										"precision": 0
									}
								]
							}
						},
						{
							"key": "payment",
							"label": "Tổng cộng",
							"width": "150px",
							"currency": "VN",
							"type": "number",
							"calculation": {
								"calculations": [
									{
										"formula": "[payment] = [amount] + [vat]",
										"dependencies": [
											"amount",
											"vat"
										],
										"precision": 0
									}
								]
							}
						},
						{
							"key": "note",
							"width": "150px",
							"label": "Ghi chú",
							"type": "text"
						}
					],
					"initialData": []
				}
			]
		}
	],
	"dataProcessing": {
		"actions": {
			"post": [
				{
					"step": "beforeUpdate",
					"type": "sql01",
					"query": "exec beforeUpdateOrder N'@idGui', N'@voucherNumber', N'@voucherDate';"
				},
				{
					"step": "afterUpdate",
					"type": "sql02",
					"query": "exec afterUpdateOrder N'@idGui', N'@voucherNumber', N'@voucherDate';"
				}
			]
		}
	}
}